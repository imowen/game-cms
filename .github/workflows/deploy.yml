name: ğŸ® Deploy Game CMS to VPS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ§¹ Run linting
        run: npm run lint
        continue-on-error: true

  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ğŸ® Starting Game CMS deployment..."

            # å¯¼èˆªåˆ°é¡¹ç›®ç›®å½•
            cd /data/www/ggame.ee || {
              echo "âŒ Project directory not found"
              exit 1
            }

            # å¤‡ä»½æ•°æ®åº“æ–‡ä»¶
            echo "ğŸ’¾ Backing up database..."
            if [ -f "games.db" ]; then
              cp games.db games.db.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… Database backed up successfully"
            else
              echo "âš ï¸  No existing database found, will create new one"
            fi

            # å¼ºåˆ¶æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ Pulling latest code..."
            git reset --hard HEAD
            git pull origin main || {
              echo "âš ï¸  Git pull failed, checking current status..."
              git log --oneline -3
              echo "Continuing with existing code..."
            }

            # æ¢å¤æ•°æ®åº“æ–‡ä»¶
            echo "ğŸ”„ Restoring database..."
            LATEST_BACKUP=$(ls -t games.db.backup.* 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ] && [ -f "$LATEST_BACKUP" ]; then
              cp "$LATEST_BACKUP" games.db
              echo "âœ… Database restored from backup: $LATEST_BACKUP"
            else
              echo "âš ï¸  No backup found, database will be recreated"
            fi

            # æ¸…ç†å¹¶é‡æ–°å®‰è£…ä¾èµ–
            echo "ğŸ“¦ Reinstalling dependencies..."
            rm -rf node_modules
            npm ci

            # è¿è¡Œæ•°æ®åº“è¿ç§»
            echo "ğŸ—„ï¸ Running database migration..."
            npm run migrate

            # æ¸…ç†æ‰€æœ‰ç¼“å­˜
            echo "ğŸ§¹ Clearing all caches..."
            rm -rf .next
            rm -rf node_modules/.cache
            rm -rf .next/cache

            # æ„å»ºé¡¹ç›®
            echo "ğŸ—ï¸ Building project..."
            NODE_ENV=production npm run build

            # é‡å¯PM2è¿›ç¨‹ï¼ˆé›¶åœæœºéƒ¨ç½²ï¼‰
            echo "ğŸ”„ Restarting PM2 process..."
            if pm2 list | grep -q "game-cms"; then
              echo "Reloading existing PM2 process..."
              pm2 reload game-cms
            else
              echo "Starting new PM2 process..."
              pm2 start npm --name "game-cms" -- start
            fi

            # ä¿å­˜PM2é…ç½®
            pm2 save

            # æ£€æŸ¥åº”ç”¨çŠ¶æ€
            echo "ğŸ” Checking application status..."
            sleep 5
            if curl -f http://localhost:3001 > /dev/null 2>&1; then
              echo "âœ… Deployment successful! Game CMS is running on port 3001."
            else
              echo "âŒ Deployment failed! Application not responding."
              pm2 logs game-cms --lines 20
              exit 1
            fi

            # æ¸…ç†æ—§çš„æ•°æ®åº“å¤‡ä»½æ–‡ä»¶ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
            echo "ğŸ§¹ Cleaning up old database backups..."
            ls -t games.db.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -f
            echo "âœ… Backup cleanup completed"

      - name: ğŸ“§ Notify on success
        if: success()
        run: |
          echo "ğŸ‰ Game CMS deployment completed successfully!"

      - name: ğŸ“§ Notify on failure
        if: failure()
        run: |
          echo "âŒ Game CMS deployment failed!"